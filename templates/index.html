<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>AI SQL Agent</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <style>
        .layout {
            display: grid;
            grid-template-columns: 280px 1fr;
            gap: 20px;
            max-width: 1400px;
            margin: auto;
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 999px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: 8px;
        }

        .badge.READ { background:#052e16; color:#22c55e; }
        .badge.WRITE { background:#3b2200; color:#f59e0b; }
        .badge.SCHEMA { background:#3b0a0a; color:#ef4444; }
        .badge.SYSTEM { background:#1e293b; color:#38bdf8; }

        /* ===== SIDEBAR ===== */
        .sidebar {
            background: #0f172a;
            border-radius: 12px;
            padding: 16px;
            height: calc(100vh - 80px);
            overflow-y: auto;
        }

        .history-item {
            padding: 10px 0;
            border-bottom: 1px solid #1e293b;
        }

        .history-meta {
            font-size: 0.75rem;
            color: #9ca3af;
        }

        .history-query {
            font-weight: 600;
            margin: 4px 0;
        }

        .history-sql {
            font-family: monospace;
            font-size: 0.75rem;
            color: #38bdf8;
        }

        .actions {
            display:flex;
            gap:10px;
            margin-bottom:10px;
        }

        @media (max-width: 900px) {
            .layout { grid-template-columns: 1fr; }
            .sidebar { height:auto; }
        }
    </style>
</head>
<body>

<header>
    <h1>üß† AI Database Agent</h1>
    <p>Natural Language ‚Üí Safe SQL Execution</p>
</header>

<div class="layout">

    <!-- ================= SIDEBAR ================= -->
    <aside class="sidebar">
        <h3>üïò Query History</h3>

        {% if history %}
            {% for h in history %}
            <div class="history-item">
                <div class="history-meta">
                    {{ h.time }}
                    <span class="badge {{ h.task }}">{{ h.task }}</span>
                    ¬∑ {{ h.status }}
                </div>
                <div class="history-query">{{ h.query }}</div>
                <div class="history-sql">
                    {{ h.sql[:80] }}{% if h.sql|length > 80 %}...{% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p style="color:#9ca3af;">No queries yet</p>
        {% endif %}
    </aside>

    <!-- ================= MAIN ================= -->
    <main class="app-container">

        <!-- QUERY INPUT -->
        <section class="query-box">
            <form method="POST" action="/">
                <textarea
                    id="command-input"
                    name="command"
                    placeholder="e.g. Show me all customers who live in Stuttgart"
                    required
                ></textarea>
                <button type="submit" class="submit">
                    Generate & Execute SQL
                </button>
            </form>
        </section>

        <!-- ERROR -->
        {% if error %}
        <section class="error-card">‚ùå {{ error }}</section>
        {% endif %}

        <!-- GENERATED SQL -->
        {% if sql %}
        <section class="card">
            <h2>
                üßæ Generated SQL
                {% if task %}
                <span class="badge {{ task }}">{{ task }}</span>
                {% endif %}
            </h2>
            <pre>{{ sql }}</pre>
        </section>
        {% endif %}

        <!-- EXPLANATION -->
        {% if explanation %}
        <section class="card">
            <h2>üß† Why this SQL was generated</h2>
            <pre style="white-space: pre-wrap;">{{ explanation }}</pre>
        </section>
        {% endif %}

        <!-- RESULTS -->
        {% if results %}
        <section class="card">

            <!-- ACTION BAR -->
            <div class="actions">
                <strong>üìä Query Results</strong>

                {% if task == "READ" %}
                <a href="/export" class="secondary link-btn">‚¨á Export CSV</a>
                {% endif %}

                <form method="POST" action="/undo">
                    <button class="secondary">‚Ü© Undo Last Change</button>
                </form>
            </div>

            <div class="table-wrapper">
                <table>
                    <thead>
                        <tr>
                            {% for col in columns %}
                            <th>{{ col }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for row in results %}
                        <tr>
                            {% for cell in row %}
                            <td>{{ cell }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>

            <!-- PAGINATION -->
            <div style="margin-top:20px; display:flex; justify-content:space-between;">
                <div>
                    Showing {{ results|length }} rows
                    {% if total_rows %} out of {{ total_rows }}{% endif %}
                </div>

                <div style="display:flex; gap:10px;">
                    {% if page > 1 %}
                    <a href="?page={{ page - 1 }}" class="secondary link-btn">‚¨Ö Previous</a>
                    {% endif %}
                    {% if total_rows and page * page_size < total_rows %}
                    <a href="?page={{ page + 1 }}" class="secondary link-btn">Next ‚û°</a>
                    {% endif %}
                </div>
            </div>
        </section>
        {% endif %}
    </main>
</div>

<footer>
    <span>‚öôÔ∏è LLM + Validator + Snapshot Protection</span>
</footer>

<script>
  const textarea = document.getElementById("command-input");
  textarea.addEventListener("keydown", function (event) {
    if (event.key === "Enter" && !event.shiftKey) {
      event.preventDefault();
      textarea.closest("form").submit();
    }
  });
</script>

</body>
</html>
